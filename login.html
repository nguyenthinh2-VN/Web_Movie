<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng nhập</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        
    </style>
</head>
<body>
    <!-- Loading Animation -->
    <div class="loading-container" id="loading-screen">
      <div id="triangle">
        <svg id="Layer_1" data-name="Layer 1" version="1.1" viewBox="0 0 2000 2000">
          <polygon class="cls-1" points="928 781 1021 951 784.5 1371.97 1618 1371.97 1530.32 1544 509 1539 928 781"></polygon>
          <polygon class="cls-3" points="1618 1371.97 784.5 1371.97 874.93 1211 1346 1211 923.1 456 1110.06 456 1618 1371.97"></polygon>
          <g id="Layer_2" data-name="Layer 2">
            <polygon class="cls-2" points="418 1372.74 509 1539 928 781 1162.32 1211 1346 1211 923.1 456 418 1372.74"></polygon>
          </g>
        </svg>
      </div>
    </div>

    <!-- Header -->
    <header class="fixed-header">
        <div class="container">
          <nav class="navbar navbar-expand-lg">
            <div class="container-fluid">
              <a class="navbar-brand logo" href="index.html">Movie Tickets</a>
              <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                  <li class="nav-item">
                    <a class="nav-link" href="index.html">Phim Đang Chiếu</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="upcoming.html">Phim Sắp Chiếu</a>
                  </li>
                  <li class="nav-item">
                    <span id="user-info" class="nav-link user-info d-none"></span>
                  </li>
                  <li class="nav-item">
                    <a id="login-link" class="nav-link login-btn" href="login.html">Đăng nhập</a>
                  </li>
                  <li class="nav-item">
                    <a id="logout-link" class="nav-link logout-btn d-none" href="#" onclick="handleLogout()">Đăng xuất</a>
                  </li>
                </ul>
              </div>
            </div>
          </nav>
        </div>
      </header>

    <div class="container flex-grow-1">
        <div class="auth-container">
            <h2>Đăng nhập</h2>
            
            <!-- Alert messages -->
            <div id="error-alert" class="alert alert-danger" role="alert"></div>
            <div id="success-alert" class="alert alert-success" role="alert"></div>

            <form id="login-form">
                <div class="form-group">
                    <label for="username">Tên đăng nhập</label>
                    <input type="text" class="form-control" id="username" name="username" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Mật khẩu</label>
                    <input type="password" class="form-control" id="password" name="password" required>
                </div>

                <button type="submit" class="btn btn-primary auth-btn form-btn">Đăng nhập</button>
            </form>

            <div class="auth-links">
                <p>Chưa có tài khoản? <a href="register.html">Đăng ký ngay</a></p>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const errorAlert = document.getElementById('error-alert');
            const successAlert = document.getElementById('success-alert');
            
            // Kiểm tra xem có phải đang đăng nhập admin không
            const urlParams = new URLSearchParams(window.location.search);
            const isAdmin = urlParams.get('admin') === 'true';
            
            // Ẩn các thông báo cũ
            errorAlert.style.display = 'none';
            successAlert.style.display = 'none';

            try {
                const response = await fetch('http://localhost:5500/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        username: username,
                        password: password
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.status === "OK") {
                    // Kiểm tra role nếu là trang admin
                    if (isAdmin && data.user.role !== 1) {
                        errorAlert.textContent = 'Bạn không có quyền truy cập trang admin';
                        errorAlert.style.display = 'block';
                        return;
                    }

                    // Lưu token vào localStorage
                    localStorage.setItem('token', data.token);
                    if (data.user) {
                        localStorage.setItem('user', JSON.stringify(data.user));
                    }
                    
                    successAlert.textContent = 'Đăng nhập thành công!';
                    successAlert.style.display = 'block';
                    
                    // Redirect dựa vào loại đăng nhập
                    setTimeout(() => {
                        if (isAdmin) {
                            // Tạo phiên đăng nhập dashboard
                            sessionStorage.setItem('dashboardSession', 'true');
                            window.location.href = 'dashboard.html';
                        } else {
                            const redirectUrl = urlParams.get('redirect') || 'index.html';
                            window.location.href = redirectUrl;
                        }
                    }, 1000);
                } else {
                    throw new Error(data.msg || 'Đăng nhập thất bại');
                }
            } catch (error) {
                console.error('Lỗi:', error);
                errorAlert.textContent = error.message;
                errorAlert.style.display = 'block';
            }
        });

        // Kiểm tra xem có phải trang admin không
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const isAdmin = urlParams.get('admin') === 'true';
            if (isAdmin) {
                document.title = 'Admin Đăng nhập';
                document.querySelector('h2').textContent = 'Admin Đăng nhập';
            }
        }
    </script>

    <script src="js/auth-header.js"></script>
    <script src="js/loading.js"></script>
</body>
</html>